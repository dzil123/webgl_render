{"version":3,"file":"gltf.js","sourceRoot":"","sources":["../../src/gltf.ts"],"names":[],"mappings":"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","sourcesContent":["import { GL, GL2, VertexAttributeLayout } from \"./webgl.js\";\nimport * as util from \"./util.js\";\n\ninterface Gltf {\n  readonly asset: { version: \"2.0\" };\n  buffers: Buffer[];\n  meshes: Mesh[];\n  accessors: Accessor[] & SpecialAccessor;\n  bufferViews: BufferView[];\n}\n\nconst GLTF_DEFAULT: Gltf = {\n  asset: { version: \"2.0\" },\n  buffers: [],\n  meshes: [],\n  accessors: [],\n  bufferViews: [],\n};\n\nenum AccessorTypeEnum {\n  SCALAR,\n  VEC2,\n  VEC3,\n  VEC4,\n  MAT2,\n  MAT3,\n  MAT4,\n}\ntype AccessorType = keyof typeof AccessorTypeEnum;\n\nfunction accessorTypeToNumComponents<T extends AccessorType>(\n  t: T,\n): (typeof LUT)[(typeof AccessorTypeEnum)[T]] {\n  const LUT = {\n    [AccessorTypeEnum.SCALAR]: 1,\n    [AccessorTypeEnum.VEC2]: 2,\n    [AccessorTypeEnum.VEC3]: 3,\n    [AccessorTypeEnum.VEC4]: 4,\n    [AccessorTypeEnum.MAT2]: 4,\n    [AccessorTypeEnum.MAT3]: 9,\n    [AccessorTypeEnum.MAT4]: 16,\n  } as const;\n\n  return LUT[AccessorTypeEnum[t]];\n}\n\nfunction componentTypeToByteSize(\n  t: GL.ArrayType | GL.GLenum<\"INT\"> | GL.GLenum<\"UNSIGNED_INT\">,\n): number {\n  const LUT = {\n    5120: 1, // BYTE\n    5121: 1, // UNSIGNED_BYTE\n    5122: 2, // SHORT\n    5123: 2, // UNSIGNED_SHORT\n    5124: 4, // INT\n    5125: 4, // UNSIGNED_INT\n    5126: 4, // FLOAT\n  } as Record<typeof t, number>;\n\n  return LUT[t]!;\n}\n\ninterface Accessor {\n  bufferView?: number; // -> bufferViews\n  byteOffset?: number;\n  componentType: GL.ArrayType | GL.GLenum<\"UNSIGNED_INT\">;\n  count: number;\n  type: AccessorType;\n  normalized?: boolean;\n}\n\ninterface BufferView {\n  buffer: number; // -> buffers\n  byteOffset?: number;\n  byteLength: number;\n  byteStride?: number;\n  target?: GL.BufferTarget;\n}\n\ninterface Buffer {\n  uri?: string;\n  byteLength: number;\n}\n\ninterface Mesh {\n  primitives: Primitive[];\n}\n\ninterface Primitive {\n  attributes: { [key: string]: number } & SpecialAttribute; // -> accessors\n  indices?: Indices; // -> accessors\n  mode?: GL.DrawMode;\n}\n\ntype Brand<S extends string> = number & { __brand: S };\n\ntype SpecialTypes = {\n  POSITION: { componentType: GL.GLenum<\"FLOAT\">; type: \"VEC3\" };\n  NORMAL: { componentType: GL.GLenum<\"FLOAT\">; type: \"VEC3\" };\n};\n\ntype Indices = Brand<\"Indices\">;\ntype IndicesComponentType =\n  | GL.GLenum<\"UNSIGNED_BYTE\">\n  | GL.GLenum<\"UNSIGNED_SHORT\">\n  | GL.GLenum<\"UNSIGNED_INT\">;\n\ntype SpecialAccessor = {\n  [K in keyof SpecialTypes as Brand<K>]: SpecialTypes[K];\n} & {\n  [x: Indices]: {\n    componentType: IndicesComponentType;\n    type: \"SCALAR\";\n  };\n};\n\ntype SpecialAttribute = { [K in keyof SpecialTypes]?: Brand<K> };\n\ninterface Scene {\n  buffers: ArrayBuffer[];\n  bufferViews: {\n    arrayView: BufferSource;\n    glBuffer: WebGLBuffer;\n    target: GL.BufferTarget;\n  }[];\n  meshes: {\n    primitives: RenderMode[];\n  }[];\n}\n\nasync function downloadBuffer(buffer: Buffer): Promise<ArrayBuffer> {\n  const uri = util.nonnull(buffer.uri);\n  const data = await util.download(\"models/\", uri, (r) => r.arrayBuffer());\n  if (data.byteLength != buffer.byteLength) {\n    throw new Error(\"Size doesn't match\", { cause: { data, buffer } });\n  }\n  return data;\n}\n\nfunction loadBufferView(\n  gl: GL2,\n  bufferView: BufferView,\n  scene: Pick<Scene, \"buffers\">,\n): Scene[\"bufferViews\"][0] {\n  if (bufferView.byteStride !== undefined) {\n    throw new Error(\"byteStride unsupported\");\n  }\n\n  const array = util.nonnull(scene.buffers[bufferView.buffer]);\n  const offset = bufferView.byteOffset || 0;\n  const target = util.nonnull(bufferView.target); // TODO: lift restriction?\n\n  // TODO: is it ok to use Uint8 regardless of AccessorType?\n  const arrayView = new Uint8Array(array, offset, bufferView.byteLength);\n\n  const glBuffer = util.nonnull(gl.createBuffer());\n  gl.bindBuffer(target, glBuffer);\n  gl.bufferData(target, arrayView, gl.STATIC_DRAW);\n  gl.bindBuffer(target, null);\n\n  return { arrayView, glBuffer, target };\n}\n\ninterface RenderSkip {\n  skipRender: true;\n}\n\ninterface RenderCommon {\n  drawMode: GL.DrawMode;\n  vao: WebGLVertexArrayObject;\n}\n\ninterface RenderArray extends RenderCommon {\n  drawArrayCount: number;\n}\n\ninterface RenderElements extends RenderCommon {\n  drawElementsCount: number;\n  byteOffset: number;\n  componentType: IndicesComponentType;\n}\n\ntype RenderMode = RenderSkip | RenderArray | RenderElements;\n\nfunction loadPrimitive(\n  gl: GL2,\n  gltf: Gltf,\n  primitive: Primitive,\n  scene: Pick<Scene, \"buffers\" | \"bufferViews\">,\n): RenderMode {\n  util.nonnull(gl.getParameter(gl.CURRENT_PROGRAM)); // must set program prior\n\n  const vao = util.nonnull(gl.createVertexArray());\n  gl.bindVertexArray(vao);\n\n  let renderMode: RenderMode = { skipRender: true };\n  const renderShared: RenderCommon = {\n    drawMode: primitive.mode ?? gl.TRIANGLES,\n    vao,\n  };\n\n  attributesBlock: {\n    positionBlock: {\n      const vertexPosition = VertexAttributeLayout.Position;\n\n      const accessorIndex = primitive.attributes[\"POSITION\"];\n      if (accessorIndex === undefined) {\n        renderMode = { skipRender: true };\n        break attributesBlock;\n      }\n\n      const accessor = util.nonnull(gltf.accessors[accessorIndex]);\n      console.assert(accessor.type === \"VEC3\");\n      console.assert(accessor.componentType === gl.FLOAT);\n      // accessor.normalized known false\n\n      const bufferViewIndex = accessor.bufferView;\n      if (bufferViewIndex === undefined) {\n        gl.disableVertexAttribArray(vertexPosition);\n        gl.vertexAttrib3f(vertexPosition, 0, 0, 0);\n        break positionBlock;\n      }\n      const gltfBufferView = util.nonnull(gltf.bufferViews[bufferViewIndex]);\n      const bufferView = util.nonnull(scene.bufferViews[bufferViewIndex]);\n      console.assert(bufferView.target === gl.ARRAY_BUFFER);\n\n      gl.bindBuffer(bufferView.target, bufferView.glBuffer);\n      gl.enableVertexAttribArray(vertexPosition);\n      gl.vertexAttribPointer(\n        vertexPosition,\n        accessorTypeToNumComponents(accessor.type),\n        accessor.componentType,\n        accessor.normalized ?? false,\n        gltfBufferView.byteStride ?? 0,\n        accessor.byteOffset ?? 0,\n      );\n      gl.bindBuffer(bufferView.target, null);\n\n      renderMode = {\n        ...renderShared,\n        drawArrayCount: accessor.count,\n      };\n    }\n\n    normalBlock: {\n      const vertexNormal = VertexAttributeLayout.Normal;\n\n      const accessorIndex = primitive.attributes[\"NORMAL\"];\n      if (accessorIndex === undefined) {\n        break normalBlock;\n      }\n\n      const accessor = util.nonnull(gltf.accessors[accessorIndex]);\n      console.assert(accessor.type === \"VEC3\");\n      console.assert(accessor.componentType === gl.FLOAT);\n      // accessor.normalized known false\n\n      const bufferViewIndex = accessor.bufferView;\n      if (bufferViewIndex === undefined) {\n        gl.disableVertexAttribArray(vertexNormal);\n        gl.vertexAttrib3f(vertexNormal, 0, 0, 0);\n        break normalBlock;\n      }\n\n      const gltfBufferView = util.nonnull(gltf.bufferViews[bufferViewIndex]);\n      const bufferView = util.nonnull(scene.bufferViews[bufferViewIndex]);\n      console.assert(bufferView.target === gl.ARRAY_BUFFER);\n\n      gl.bindBuffer(bufferView.target, bufferView.glBuffer);\n      gl.enableVertexAttribArray(vertexNormal);\n      gl.vertexAttribPointer(\n        vertexNormal,\n        accessorTypeToNumComponents(accessor.type),\n        accessor.componentType,\n        accessor.normalized ?? false,\n        gltfBufferView.byteStride ?? 0,\n        accessor.byteOffset ?? 0,\n      );\n      gl.bindBuffer(bufferView.target, null);\n    }\n\n    indicesBlock: {\n      const accessorIndex = primitive.indices;\n      if (accessorIndex === undefined) {\n        break indicesBlock;\n      }\n\n      const accessor = util.nonnull(gltf.accessors[accessorIndex]);\n      console.assert(accessor.type === \"SCALAR\");\n      console.assert(\n        [gl.UNSIGNED_BYTE, gl.UNSIGNED_SHORT, gl.UNSIGNED_INT].includes(\n          accessor.componentType,\n        ),\n      );\n\n      const bufferViewIndex = accessor.bufferView;\n      if (bufferViewIndex === undefined) {\n        throw new Error(\"Meaningless\");\n      }\n      const gltfBufferView = util.nonnull(gltf.bufferViews[bufferViewIndex]);\n      const bufferView = util.nonnull(scene.bufferViews[bufferViewIndex]);\n      console.assert(bufferView.target === gl.ELEMENT_ARRAY_BUFFER);\n      console.assert(gltfBufferView.byteStride === undefined);\n\n      gl.bindBuffer(bufferView.target, bufferView.glBuffer);\n\n      let offset = 0;\n      if (accessor.byteOffset !== undefined) {\n        offset =\n          accessor.byteOffset / componentTypeToByteSize(accessor.componentType);\n        console.assert(Number.isInteger(offset));\n      }\n\n      renderMode = {\n        ...renderShared,\n        drawElementsCount: accessor.count,\n        byteOffset: offset,\n        componentType: accessor.componentType,\n      };\n    }\n  }\n\n  gl.bindVertexArray(null);\n\n  if (\"skipRender\" in renderMode) {\n    renderMode satisfies RenderSkip;\n    gl.deleteVertexArray(vao);\n  }\n\n  return renderMode;\n}\n\nexport function draw(gl: GL2, renderMode: RenderMode) {\n  if (\"skipRender\" in renderMode) {\n    renderMode satisfies RenderSkip;\n    return;\n  }\n\n  gl.bindVertexArray(renderMode.vao);\n\n  if (\"drawArrayCount\" in renderMode) {\n    renderMode satisfies RenderArray;\n    gl.drawArrays(renderMode.drawMode, 0, renderMode.drawArrayCount);\n  } else {\n    renderMode satisfies RenderElements;\n    gl.drawElements(\n      renderMode.drawMode,\n      renderMode.drawElementsCount,\n      renderMode.componentType as never, // overloads are broken\n      renderMode.byteOffset,\n    );\n  }\n\n  gl.bindVertexArray(null);\n}\n\nasync function downloadGltf(name: string): Promise<Gltf> {\n  const gltf = (await util.download(\"models/\", name, (r) =>\n    r.json(),\n  )) as Partial<Gltf>;\n  console.dir(gltf);\n\n  if (gltf?.asset?.version === \"2.0\") {\n    return { ...GLTF_DEFAULT, ...gltf };\n  }\n\n  throw new Error(\"Unsupported gltf\", { cause: { asset: gltf.asset } });\n}\n\nexport async function loadGltf(gl: GL2, name: string): Promise<[Gltf, Scene]> {\n  const gltf = await downloadGltf(name);\n\n  const scene: Partial<Scene> = {};\n\n  scene.buffers = await Promise.all(gltf.buffers.map(downloadBuffer));\n\n  scene.bufferViews = gltf.bufferViews.map((v) =>\n    loadBufferView(gl, v, scene as never),\n  );\n\n  scene.meshes = gltf.meshes.map((mesh) => ({\n    primitives: mesh.primitives.map((v) =>\n      loadPrimitive(gl, gltf, v, scene as never),\n    ),\n  }));\n\n  return [gltf, scene as Scene];\n}\n"]}